<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file
 * 
 * @copyright 2018 {@link https://limin.github.io Min Li}
 * 
 * @license Licensed under {@link https://www.apache.org/licenses/LICENSE-2.0.html Apache License 2.0}
 * 
 */

const byteof =require('byteof') 

const DEFAULT_TTL=3600*24*360 //one year
const DEFAULT_MAX=10 //10 megabytes

/**
 * 
 * A simple in-memory cache.
 * 
 */
class Simache{
   /**
    * 
    * @param {number} max - The max memory size in megabytes used by the cache
    */
   constructor(max=DEFAULT_MAX){
     //convert to bytes. 
    this.max=max*1024*1024
    this.size=0
    this.cache={} //key:{value,hits,expiredAt}
    this.keys=[]
   }
  
   /**
    * 
    * Get the value from cache of the key
    * 
    * @param {string} key - The key to be used to retrieve the cached value
    * @returns {*} The cached value or null if
    * &lt;ul>
    * &lt;li>The key doesn't exist&lt;/li>
    * &lt;li>The cache has been expired&lt;/li>
    * &lt;/ul>
    */
   get(key){
    const value=this.cache[key]
    if(!value) return null    
    if(value.expiredAt&lt;=Date.now()){
      this.remove(key)
      return null
    }else{
      value.hits++
      return {...value}    
    }
   }

   /**
    * 
    * Set the cached value 
    * 
    * @param {string} key - The key of the cached value
    * @param {*} value - The cached value
    * @param {number} ttl - The time to live of the cache in seconds
    */
   set(key,value,ttl=DEFAULT_TTL){
    const bytes=byteof(value)
    if(bytes>this.max){
      throw new Error("The object is too big to be cached.")
    }     
    key=new String(key)
    if(this.cache[key]){    
      this.remove(key)
    }

    while(this.size+bytes>this.max){
      this.remove(this.keys[0])
    }
    const v={
      value,
      hits:0,
      expiredAt: Date.now()+ttl*1000
    }    
    this.keys.push(key)    
    this.cache[key]=v
    this.size+=byteof(value)
   }

   /**
    * 
    * Remove the cached value with key from cache
    * 
    * @param {string} key 
    */
   remove(key){
    const o=this.cache[key]
    if(o){
      this.size-=byteof(this.cache[key].value)
      const index=this.keys.indexOf(key)
      this.keys.splice(index,1)    
      delete this.cache[key]  
    }
   }
}

module.exports=Simache</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Simache.html">Simache</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Sep 22 2018 13:39:05 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
